@startuml
'https://plantuml.com/sequence-diagram

autonumber
participant "Google" as Google #green
participant "建站" as Station #green
participant "Merchant" as Merchant #skyblue
participant "S3" as S3 #skyblue
participant "Product" as Product #skyblue
participant "Redis" as Redis #skyblue
Google -> Station: 访问siteMap链接 domain+"/sitemap_pages_1.xml"
Station -> Merchant: 调用接口（/api/merchant/store/sitemap/station,header带上domain和path,cookie带上storeId）
Merchant -> Merchant: 根据domain查找storeId，校验domain的合法性
Merchant -> MySQL: 根据storeId、domain、path查询sitemap_pages_1的上传记录
MySQL --> Merchant: 返回查询结果
alt null != siteMapRecord
Merchant -> S3: 根据 key 下载文件
note right: 查询不做过期时间判断，统一由定时任务完成定时刷新
S3 --> Merchant: 返回文件内容
Merchant --> Station: 返回xml内容
Station --> Google: 返回xml内容
else null == siteMapRecord
Merchant -> Redis: 利用 Redisson 获取分布式锁
note right: key 的粒度细到店铺的每个domain\nkey: sitemap:page:storeId:domain:path、waitTime：10s、leaseTime：60*10s
alt tryLock -> true
Merchant -> MySQL: 根据storeId、domain、path查询sitemap.xml的上传记录
note right: 二次检查，防止等待的线程在等待超时前拿到了锁，继续生成新的文件新的记录
MySQL --> Merchant: 返回查询结果
alt null == siteMapRecord
Merchant -> MySQL: 查询店铺预设置页面
MySQL -> Merchant: 返回结果
Merchant -> Merchant: 生成xml文件
Merchant -> S3: 上传文件
else null != siteMapRecord
Merchant -> S3: 根据 key 下载文件
S3 --> Merchant: 返回文件内容
end
Merchant -> Redis: 释放锁
Merchant --> Station: 返回xml内容
Station --> Google: 返回xml内容
else tryLock -> false
Merchant --> Station: 返回默认值
Station --> Google: 返回默认值
end
end
@enduml